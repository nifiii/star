# 使用 Node 20 作为基础镜像，因为它包含运行 Puppeteer 所需的环境基础
FROM node:20-slim

# 设置工作目录
WORKDIR /app

# 1. 安装 Nginx 和 Puppeteer (Chrome) 所需的系统依赖
# Puppeteer 需要一系列库才能在 Docker 中运行无头浏览器
RUN apt-get update && apt-get install -y \
    nginx \
    chromium \
    fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# 告诉 Puppeteer 跳过下载 Chrome，我们将使用上面安装的系统 Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# 2. 复制依赖文件并安装项目依赖
COPY package*.json ./
RUN npm install

# 3. 复制源代码
COPY . .

# 4. 构建 React 应用
# 接受构建参数 API_KEY (Vite 在构建时需要)
ARG API_KEY
ENV API_KEY=$API_KEY
RUN npm run build

# 5. 配置 Nginx
# 将构建好的 React 文件 (dist) 移动到 Nginx 标准目录
RUN rm -rf /var/www/html/* && cp -r dist/* /var/www/html/

# 复制自定义的 Nginx 配置 (确保文件名为 nginx.conf.txt 或重命名)
COPY nginx.conf.txt /etc/nginx/conf.d/default.conf

# 6. 关键步骤：路径映射
# 脚本 scripts/getToken.js 会写入到 "../public/auth_config.json"
# 1. 在 Docker 运行环境中，脚本位于 /app/scripts/getToken.js
# 2. "../public" 解析为 "/app/public"
# 3. 我们删除原有的 /app/public 目录（如果拷贝进来了），并将其软链接到 Nginx 的根目录
# 4. 这样脚本写入的文件实际上就是写入到了 Nginx 的 Web 根目录，前端就能读到了
RUN rm -rf /app/public && ln -s /var/www/html /app/public

# 暴露端口
EXPOSE 80

# 7. 启动命令
# 同时启动：
# 1. npm run get-token (后台运行 &)
# 2. nginx (前台运行，保持容器存活)
CMD npm run get-token & nginx -g 'daemon off;'