# 使用 Node 20 作为基础镜像 (原生支持 fetch API)
FROM node:20-slim

# 设置工作目录
WORKDIR /app

# 1. 安装 Nginx 和 时区数据 (tzdata)
# tzdata 对于确保后台脚本按正确的本地时间（如北京时间 5:00）运行至关重要
RUN apt-get update && apt-get install -y \
    nginx \
    tzdata \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# 设置默认时区 (可通过 docker run -e TZ=... 覆盖)
ENV TZ=Asia/Shanghai
# 标记 Docker 环境，供后台脚本识别路径 (/app/data vs ../data)
ENV IS_DOCKER=true

# 2. 复制依赖文件并安装项目依赖
COPY package*.json ./
RUN npm install

# 3. 复制源代码
COPY . .

# 4. 构建 React 应用
# 接受构建参数 API_KEY (Vite 在构建时需要将其注入到前端代码中)
ARG API_KEY
ENV API_KEY=$API_KEY
RUN npm run build

# 5. 配置 Nginx
# 将构建好的 React 文件 (dist) 移动到 Nginx 标准目录
RUN rm -rf /var/www/html/* && cp -r dist/* /var/www/html/

# 复制自定义的 Nginx 配置
COPY nginx.conf.txt /etc/nginx/conf.d/default.conf

# 6. 数据持久化配置
# 创建数据目录用于挂载 Volume
# 后台脚本会将数据写入此处，并创建软链接到 /var/www/html/ 供 Nginx 服务
RUN mkdir -p /app/data

# 声明 Volume, 部署时需挂载 -v host_path:/app/data
# 这确保了即使容器删除，爬取到的排名和比分数据也不会丢失
VOLUME ["/app/data"]

# 暴露端口
EXPOSE 80

# 7. 启动命令
# 同时启动：
# 1. npm run get-token (后台运行 &): 负责每日数据更新、Token 刷新和文件软链维护
# 2. nginx (前台运行): 提供 Web 服务
CMD npm run get-token & nginx -g 'daemon off;'